import unittest
import numpy as np
from spflow.python.structure.nodes.node_module import (
    Node,
    SumNode,
    ProductNode,
    LeafNode,
)
from spflow.python.structure.module import _get_node_counts
from spflow.python.structure.network_type import SPN
from spflow.python.structure.nodes.validity_checks import _isvalid_spn


class TestNode(unittest.TestCase):
    def test_spn_fail_scope1(self):
        spn_module: Node = ProductNode(
            children=[
                LeafNode(scope=[1], network_type=SPN()),
                LeafNode(scope=[1], network_type=SPN()),
            ],
            scope=[1, 2],
            network_type=SPN(),
        )

        with self.assertRaises(AssertionError):
            _isvalid_spn(spn_module)

    def test_spn_fail_scope2(self):
        spn_module: Node = ProductNode(
            children=[
                LeafNode(scope=[1], network_type=SPN()),
                LeafNode(scope=[2], network_type=SPN()),
            ],
            scope=[1],
            network_type=SPN(),
        )

        with self.assertRaises(AssertionError):
            _isvalid_spn(spn_module)

    def test_spn_fail_weights1(self):
        with self.assertRaises(AssertionError):
            spn_module: Node = SumNode(
                children=[
                    LeafNode(scope=[1], network_type=SPN()),
                    LeafNode(scope=[1], network_type=SPN()),
                ],
                scope=[1],
                weights=np.array([0.49, 0.49]),
                network_type=SPN(),
            )

    def test_spn_fail_weights2(self):
        with self.assertRaises(AssertionError):
            spn_module: Node = SumNode(
                children=[
                    LeafNode(scope=[1], network_type=SPN()),
                    LeafNode(scope=[1], network_type=SPN()),
                ],
                scope=[1],
                weights=np.array([1.0]),
                network_type=SPN(),
            )

    def test_spn_missing_children(self):
        spn_module: Node = ProductNode(children=[], scope=[1, 2], network_type=SPN())

        with self.assertRaises(AssertionError):
            _isvalid_spn(spn_module)

    def test_spn_fail_leaf_with_children(self):
        spn_module: Node = SumNode(
            children=[
                LeafNode(scope=[1], network_type=SPN()),
                LeafNode(scope=[1], network_type=SPN()),
            ],
            scope=[1],
            weights=np.array([0.5, 0.5]),
            network_type=SPN(),
        )

        # make sure SPN is valid to begin with
        _isvalid_spn(spn_module)

        spn_module.output_nodes[0].children[0].children.append(
            LeafNode(scope=[1], network_type=SPN())
        )

        with self.assertRaises(AssertionError):
            _isvalid_spn(spn_module)

    def test_spn_fail_none_children(self):
        with self.assertRaises(AssertionError):
            spn_module: Node = ProductNode(
                children=[LeafNode(scope=[1], network_type=SPN()), None],
                scope=[1, 2],
                network_type=SPN(),
            )

    def test_spn_tree_small(self):
        spn_module: Node = ProductNode(
            children=[
                SumNode(
                    children=[
                        LeafNode(scope=[1], network_type=SPN()),
                        LeafNode(scope=[1], network_type=SPN()),
                    ],
                    scope=[1],
                    weights=np.array([0.3, 0.7]),
                    network_type=SPN(),
                ),
                LeafNode(scope=[2], network_type=SPN()),
            ],
            scope=[1, 2],
            network_type=SPN(),
        )
        _isvalid_spn(spn_module)
        sum_nodes, prod_nodes, leaf_nodes = _get_node_counts(spn_module)
        self.assertEqual(sum_nodes, 1)
        self.assertEqual(prod_nodes, 1)
        self.assertEqual(leaf_nodes, 3)

    def test_spn_tree_big(self):
        spn_module: Node = ProductNode(
            children=[
                SumNode(
                    children=[
                        ProductNode(
                            children=[
                                SumNode(
                                    children=[
                                        ProductNode(
                                            children=[
                                                LeafNode(scope=[1], network_type=SPN()),
                                                LeafNode(scope=[2], network_type=SPN()),
                                            ],
                                            scope=[1, 2],
                                            network_type=SPN(),
                                        ),
                                        LeafNode(scope=[1, 2], network_type=SPN()),
                                    ],
                                    scope=[1, 2],
                                    weights=np.array([0.9, 0.1]),
                                    network_type=SPN(),
                                ),
                                LeafNode(scope=[3], network_type=SPN()),
                            ],
                            scope=[1, 2, 3],
                            network_type=SPN(),
                        ),
                        ProductNode(
                            children=[
                                LeafNode(scope=[1], network_type=SPN()),
                                SumNode(
                                    children=[
                                        LeafNode(scope=[2, 3], network_type=SPN()),
                                        LeafNode(scope=[2, 3], network_type=SPN()),
                                    ],
                                    scope=[2, 3],
                                    weights=np.array([0.5, 0.5]),
                                    network_type=SPN(),
                                ),
                            ],
                            scope=[1, 2, 3],
                            network_type=SPN(),
                        ),
                        LeafNode(scope=[1, 2, 3], network_type=SPN()),
                    ],
                    scope=[1, 2, 3],
                    weights=np.array([0.4, 0.1, 0.5]),
                    network_type=SPN(),
                ),
                SumNode(
                    children=[
                        ProductNode(
                            children=[
                                LeafNode(scope=[4], network_type=SPN()),
                                LeafNode(scope=[5], network_type=SPN()),
                            ],
                            scope=[4, 5],
                            network_type=SPN(),
                        ),
                        LeafNode(scope=[4, 5], network_type=SPN()),
                    ],
                    scope=[4, 5],
                    weights=np.array([0.5, 0.5]),
                    network_type=SPN(),
                ),
            ],
            scope=[1, 2, 3, 4, 5],
            network_type=SPN(),
        )

        _isvalid_spn(spn_module)
        sum_nodes, prod_nodes, leaf_nodes = _get_node_counts(spn_module)
        self.assertEqual(sum_nodes, 4)
        self.assertEqual(prod_nodes, 5)
        self.assertEqual(leaf_nodes, 11)

    def test_spn_graph_small(self):
        leaf1 = LeafNode(scope=[1], network_type=SPN())
        leaf2 = LeafNode(scope=[2], network_type=SPN())
        prod1 = ProductNode(children=[leaf1, leaf2], scope=[1, 2], network_type=SPN())
        prod2 = ProductNode(children=[leaf1, leaf2], scope=[1, 2], network_type=SPN())
        sum = SumNode(
            children=[prod1, prod2], scope=[1, 2], weights=np.array([0.3, 0.7]), network_type=SPN()
        )

        _isvalid_spn(sum)
        sum_nodes, prod_nodes, leaf_nodes = _get_node_counts(sum)
        self.assertEqual(sum_nodes, 1)
        self.assertEqual(prod_nodes, 2)
        self.assertEqual(leaf_nodes, 2)

    def test_spn_graph_medium(self):
        leaf_11 = LeafNode(scope=[1], network_type=SPN())
        leaf_12 = LeafNode(scope=[1], network_type=SPN())
        leaf_21 = LeafNode(scope=[2], network_type=SPN())
        leaf_22 = LeafNode(scope=[2], network_type=SPN())
        sum_11 = SumNode(
            children=[leaf_11, leaf_12], scope=[1], weights=np.array([0.3, 0.7]), network_type=SPN()
        )
        sum_12 = SumNode(
            children=[leaf_11, leaf_12], scope=[1], weights=np.array([0.9, 0.1]), network_type=SPN()
        )
        sum_21 = SumNode(
            children=[leaf_21, leaf_22], scope=[2], weights=np.array([0.4, 0.6]), network_type=SPN()
        )
        sum_22 = SumNode(
            children=[leaf_21, leaf_22], scope=[2], weights=np.array([0.8, 0.2]), network_type=SPN()
        )
        prod_11 = ProductNode(children=[sum_11, sum_21], scope=[1, 2], network_type=SPN())
        prod_12 = ProductNode(children=[sum_11, sum_22], scope=[1, 2], network_type=SPN())
        prod_13 = ProductNode(children=[sum_12, sum_21], scope=[1, 2], network_type=SPN())
        prod_14 = ProductNode(children=[sum_12, sum_22], scope=[1, 2], network_type=SPN())
        sum = SumNode(
            children=[prod_11, prod_12, prod_13, prod_14],
            scope=[1, 2],
            weights=np.array([0.1, 0.2, 0.3, 0.4]),
            network_type=SPN(),
        )

        _isvalid_spn(sum)

        sum_nodes, prod_nodes, leaf_nodes = _get_node_counts(sum)
        self.assertEqual(sum_nodes, 5)
        self.assertEqual(prod_nodes, 4)
        self.assertEqual(leaf_nodes, 4)


if __name__ == "__main__":
    unittest.main()
